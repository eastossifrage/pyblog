<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Pyblog : Pyblog 是一个简单易用的在线 Markdown 博客系统，它使用 Python 的 flask 架构，理论上支持所有 flask-sqlalchemy 所能支持的数据库。博客的内容全部是 Markdown 格式，你只需要将写好的 Markdown文件的内容提交即可。同时支持多说评论，百度统计，代码高亮等常用功能。">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Pyblog</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/eastossifrage/pyblog">View on GitHub</a>

          <h1 id="project_title">Pyblog</h1>
          <h2 id="project_tagline">Pyblog 是一个简单易用的在线 Markdown 博客系统，它使用 Python 的 flask 架构，理论上支持所有 flask-sqlalchemy 所能支持的数据库。博客的内容全部是 Markdown 格式，你只需要将写好的 Markdown文件的内容提交即可。同时支持多说评论，百度统计，代码高亮等常用功能。</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/eastossifrage/pyblog/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/eastossifrage/pyblog/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="pyblog--喜欢markdown爱上pyblog" class="anchor" href="#pyblog--%E5%96%9C%E6%AC%A2markdown%E7%88%B1%E4%B8%8Apyblog" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Pyblog —— 喜欢Markdown，爱上Pyblog!</h1>

<blockquote>
<p>Pyblog 是一个简单易用的在线 Markdown 博客系统，它使用 Python 的 flask 架构，理论上支持所有 flask-sqlalchemy 所能支持的数据库。博客的内容全部是 Markdown 格式，你只需要将写好的 Markdown文件的内容提交即可。同时支持多说评论，百度统计，代码高亮等常用功能。</p>
</blockquote>

<h2>
<a id="使用用法" class="anchor" href="#%E4%BD%BF%E7%94%A8%E7%94%A8%E6%B3%95" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>使用用法</h2>

<h3>
<a id="应用环境介绍" class="anchor" href="#%E5%BA%94%E7%94%A8%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>应用环境介绍</h3>

<ul>
<li>支持 Linux 系统，本程序默认为 Ubuntu 14.04 - 16.04 系统。</li>
<li>默认的python， 2.7.6 - 2.7.11+。</li>
<li>Ubuntu 系统默认安装的nginx。</li>
<li>默认使用系统自带的 sqlite 数据库。</li>
</ul>

<h3>
<a id="文件组织架构" class="anchor" href="#%E6%96%87%E4%BB%B6%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>文件组织架构</h3>

<div class="highlight highlight-source-shell"><pre>pyblog/
    app/
    config.py
    manage.py</pre></div>

<h3>
<a id="前提条件" class="anchor" href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>前提条件</h3>

<div class="highlight highlight-source-shell"><pre>sudo apt-get install python-setuptools
sudo easy_install pip
sudo pip install virtualenv</pre></div>

<h3>
<a id="安装-nginx" class="anchor" href="#%E5%AE%89%E8%A3%85-nginx" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>安装 nginx</h3>

<div class="highlight highlight-source-shell"><pre>$ sudo add-apt-repository ppa:nginx/stable
$ sudo apt-get update <span class="pl-k">&amp;&amp;</span> sudo apt-get upgrade
$ sudo apt-get install build-essential python python-dev
$ sudo apt-get install nginx</pre></div>

<h3>
<a id="运行-nginx" class="anchor" href="#%E8%BF%90%E8%A1%8C-nginx" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>运行 nginx</h3>

<div class="highlight highlight-source-shell"><pre>$ sudo /etc/init.d/nginx start</pre></div>

<p>Nginx是一个提供静态文件访问的web服务，然而，它不能直接执行托管Python应用程序，而uWSGI解决了这个问题。让我们先安装uWSGI，稍候再配置Nginx和uWSGI之间的交互。</p>

<h3>
<a id="安装-uwsgi" class="anchor" href="#%E5%AE%89%E8%A3%85-uwsgi" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>安装 uWSGI</h3>

<div class="highlight highlight-source-shell"><pre>sudo pip install uwsgi</pre></div>

<h3>
<a id="安装-flask-的虚拟环境" class="anchor" href="#%E5%AE%89%E8%A3%85-flask-%E7%9A%84%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>安装 flask 的虚拟环境</h3>

<div class="highlight highlight-source-shell"><pre>$ <span class="pl-c1">cd</span> /var/www
$ sudo apt-get install python-virtualenv
$ sudo mkdir pyblog <span class="pl-c">#可以自定义目录的命名</span>
$ sudo chown os373:os373 -R pyblog/
$ git clone git@github.com:eastossifrage/pyblog.git
$ <span class="pl-c1">cd</span> pyblog 
$ virtualenv flask
$ <span class="pl-c1">source</span> flask/bin/activate
(flask)$
(flask)$ pip install -r requirements.txt</pre></div>

<h3>
<a id="配置-nginx" class="anchor" href="#%E9%85%8D%E7%BD%AE-nginx" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>配置 nginx</h3>

<p>首先删除掉Nginx的默认配置文件：</p>

<div class="highlight highlight-source-shell"><pre>sudo rm /etc/nginx/sites-enabled/default</pre></div>

<h4>
<a id="设置nginx用户组" class="anchor" href="#%E8%AE%BE%E7%BD%AEnginx%E7%94%A8%E6%88%B7%E7%BB%84" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>设置nginx用户组</h4>

<p>修改nginx配置<code>/etc/nginx/nginx.conf</code>的启动用户</p>

<div class="highlight highlight-source-shell"><pre>第1行 user os373  <span class="pl-c">#最好是系统的当前用户</span></pre></div>

<h4>
<a id="新建-nginx-配置文件-varwwwpyblogpyblog_nginxconf" class="anchor" href="#%E6%96%B0%E5%BB%BA-nginx-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-varwwwpyblogpyblog_nginxconf" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>新建 nginx 配置文件 <code>/var/www/pyblog/pyblog_nginx.conf</code>：</h4>

<div class="highlight highlight-source-shell"><pre>
server {
        listen 80<span class="pl-k">;</span>
        server_name os373.cn<span class="pl-k">;</span> <span class="pl-c"># 自己的网站域名</span>
        charset utf-8<span class="pl-k">;</span>
        client_max_body_size 75M<span class="pl-k">;</span>

        location / {
                try_files <span class="pl-smi">$uri</span> @pyblog<span class="pl-k">;</span>
        }
        location @pyblog {
                include uwsgi_params<span class="pl-k">;</span>
                uwsgi_pass unix:/var/www/pyblog/pyblog_uwsgi.sock<span class="pl-k">;</span>
        }
}</pre></div>

<p>将刚建立的配置文件使用符号链接到Nginx配置文件文件夹中</p>

<div class="highlight highlight-source-shell"><pre>sudo ln -s /var/www/pyblog/pyblog_nginx.conf /etc/nginx/conf.d/</pre></div>

<h3>
<a id="配置-uwsgi" class="anchor" href="#%E9%85%8D%E7%BD%AE-uwsgi" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>配置 uWSGI</h3>

<h4>
<a id="设置目录的用户权限" class="anchor" href="#%E8%AE%BE%E7%BD%AE%E7%9B%AE%E5%BD%95%E7%9A%84%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>设置目录的用户权限</h4>

<p>最好和 nginx 的进程用户一致，此处同为当前用户 os373。</p>

<div class="highlight highlight-source-shell"><pre>sudo mkdir /var/log/uwsgi
sudo chown -R os373:os373 /var/www/pyblog/
sudo chown -R os373:os373 /var/log/uwsgi/</pre></div>

<h4>
<a id="uwsgi配置文件" class="anchor" href="#uwsgi%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>uWSGI配置文件</h4>

<p>创建一个新的uWSGI配置文件/var/www/pyblog/pyblog_uwsgi.ini</p>

<div class="highlight highlight-source-shell"><pre>[uwsgi]
base = /var/www/pyblog
app = manage
module = %(app)

home = %(base)/flask
pythonpath = %(base)
socket = /var/www/pyblog/%n.sock
master = <span class="pl-c1">true</span>
processes = 8
workers = 2
chmod-socket = 644
callable = app
logto = /var/log/uwsgi/%n.log
</pre></div>

<p>执行uWSGI，用新创建的配置文件作为参数：</p>

<div class="highlight highlight-source-shell"><pre>uwsgi --ini /var/www/pybolg/pyblog_uwsgi.ini</pre></div>

<p>我们的工作现在基本完成了，唯一剩下的事情是配置uWSGI在后台运行，这是uWSGI Emperor的职责。</p>

<h4>
<a id="1---uwsgi-emperor-在-ubuntu1404上实验成功" class="anchor" href="#1---uwsgi-emperor-%E5%9C%A8-ubuntu1404%E4%B8%8A%E5%AE%9E%E9%AA%8C%E6%88%90%E5%8A%9F" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1 - uWSGI Emperor (在 ubuntu14.04上实验成功)</h4>

<p>创建一个初始配置来运行emperor - <code>sudo vi /etc/init/uwsgi.conf</code>：</p>

<div class="highlight highlight-source-shell"><pre>description <span class="pl-s"><span class="pl-pds">"</span>uWSGI<span class="pl-pds">"</span></span>
start on runlevel [2345]
stop on runlevel [06]
respawn

env UWSGI=/usr/local/bin/uwsgi
env LOGTO=/var/log/uwsgi/emperor.log

<span class="pl-c1">exec</span> <span class="pl-smi">$UWSGI</span> --master --emperor /etc/uwsgi/vassals --die-on-term --uid os373 --gid os373 --logto <span class="pl-smi">$LOGTO</span></pre></div>

<p>最后一行运行uWSGI守护进程并让它到<code>/etc/uwsgi/vassals</code>文件夹查找配置文件。创建这个文件夹，在其中建立一个到链到我们刚创建配置文件的符号链接。</p>

<div class="highlight highlight-source-shell"><pre>sudo mkdir /etc/uwsgi <span class="pl-k">&amp;&amp;</span> sudo mkdir /etc/uwsgi/vassals
sudo ln -s /var/www/pyblog/pyblog_uwsgi.ini /etc/uwsgi/vassals</pre></div>

<h4>
<a id="2---添加-uwsgi-emperor-服务到-systemd-在-ubuntu1604上实验成功" class="anchor" href="#2---%E6%B7%BB%E5%8A%A0-uwsgi-emperor-%E6%9C%8D%E5%8A%A1%E5%88%B0-systemd-%E5%9C%A8-ubuntu1604%E4%B8%8A%E5%AE%9E%E9%AA%8C%E6%88%90%E5%8A%9F" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2 - 添加 uWSGI Emperor 服务到 systemd (在 ubuntu16.04上实验成功)</h4>

<p>这里有一个知识点，就是ubuntu 16.04 使用了systemd来管理启动项
首先，创建 <code>sudo vi /etc/systemd/system/uwsgi.service</code> 文件，内容如下：</p>

<div class="highlight highlight-source-shell"><pre>[Unit]
Description=uWSGI Emperor
After=syslog.target

[Service]
ExecStart=/usr/local/bin/uwsgi --master --emperor /etc/uwsgi/vassals --uid os373 --gid os373 --logto /var/log/wuwsgi/emperor.log
Restart=always
KillSignal=SIGQUIT
Type=notify
NotifyAccess=all

[Install]
WantedBy=multi-user.target</pre></div>

<p>配置文件<code>/etc/uwsgi/vassals</code>。创建这个文件夹，在其中建立一个到链到我们刚创建配置文件的符号链接。</p>

<div class="highlight highlight-source-shell"><pre>sudo mkdir /etc/uwsgi <span class="pl-k">&amp;&amp;</span> sudo mkdir /etc/uwsgi/vassals
sudo ln -s /var/www/pyblog/pyblog_uwsgi.ini /etc/uwsgi/vassals</pre></div>

<p>现在，flask应用就应该配置完成了。</p>

<h3>
<a id="配置flask应用数据库" class="anchor" href="#%E9%85%8D%E7%BD%AEflask%E5%BA%94%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>配置flask应用数据库</h3>

<div class="highlight highlight-source-shell"><pre>(flask)$ python manage.py db init
(flask)$ python manage.py db migrate -m <span class="pl-s"><span class="pl-pds">"</span>initial migration<span class="pl-pds">"</span></span>
(flask)$ python manage.py db upgrade</pre></div>

<h4>
<a id="创建插件数据库数据" class="anchor" href="#%E5%88%9B%E5%BB%BA%E6%8F%92%E4%BB%B6%E6%95%B0%E6%8D%AE%E5%BA%93%E6%95%B0%E6%8D%AE" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>创建插件数据库数据</h4>

<div class="highlight highlight-source-shell"><pre>(flask)$ python manage.py shell
<span class="pl-k">&gt;&gt;&gt;</span> <span class="pl-en">Plugin.insert_plugins</span>()</pre></div>

<h3>
<a id="重新启动服务" class="anchor" href="#%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>重新启动服务</h3>

<h4>
<a id="1---ubuntu-1404-系统启动方式" class="anchor" href="#1---ubuntu-1404-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1 - ubuntu 14.04 系统启动方式</h4>

<div class="highlight highlight-source-shell"><pre>sudo service nginx restart
sudo service uwsgi restart</pre></div>

<h4>
<a id="2---ubuntu-1604-系统启动方式" class="anchor" href="#2---ubuntu-1604-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2 - ubuntu 16.04 系统启动方式</h4>

<div class="highlight highlight-source-shell"><pre>sudo systemctl restart nginx.service 
sudo systemctl restart uwsgi.service</pre></div>

<p>你可以查看<code>/var/log/uwsgi/</code>文件夹下的access.log和error.log内容，并根据提示来判断程序是否正常运行。</p>

<h3>
<a id="demo" class="anchor" href="#demo" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Demo</h3>

<p><a href="http://www.os373.cn">藕丝空间 —— 寻找合伙人共同追梦，共同编程！</a></p>

<h3>
<a id="wiki" class="anchor" href="#wiki" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Wiki</h3>

<p><a href="https://github.com/eastossifrage/pyblog/wiki">pyblog的wiki，详细内容参阅此处</a></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Pyblog maintained by <a href="https://github.com/eastossifrage">eastossifrage</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
